{
  "$schema": "https://raw.githubusercontent.com/invoiceradar/plugins/main/schema.json",
  "id": "amazon-de",
  "name": "Amazon",
  "description": "Get invoices from Amazon.",
  "homepage": "https://amazon.com",
  "configSchema": {
    "domain": {
      "type": "string",
      "title": "Amazon Domain",
      "description": "The Amazon domain to use (e.g. amazon.de, amazon.com, amazon.co.uk)",
      "default": "amazon.de",
      "options": [{
        "label": "Amazon.de",
        "value": "amazon.de"
      }, {
        "label": "Amazon.com",
        "value": "amazon.com"
      }, {
        "label": "Amazon.co.uk",
        "value": "amazon.co.uk"
      }, {
        "label": "Amazon.fr",
        "value": "amazon.fr"
      }, {
        "label": "Amazon.it",
        "value": "amazon.it"
      }, {
        "label": "Amazon.es",
        "value": "amazon.es"
      }, {
        "label": "Amazon.nl",
        "value": "amazon.nl"
      }, {
        "label": "Amazon.pl",
        "value": "amazon.pl"
      }, {
        "label": "Amazon.se",
        "value": "amazon.se"
      },{
        "label": "Amazon.ca",
        "value": "amazon.ca"
      },{
        "label": "Amazon.in",
        "value": "amazon.in"
      }],
      "required": true
    }
  },
  "checkAuth": [
    {
      "action": "navigate",
      "url": "https://www.{{config.domain}}/gp/css/order-history"
    },
    {
      "action": "checkURL",
      "url": "/gp/css/order-history"
    }
  ],
  "startAuth": [
    {
      "action": "navigate",
      "url": "https://www.{{config.domain}}/ap/signin?openid.pape.max_auth_age=0&openid.return_to=https%3A%2F%2Fwww.{{config.domain}}%2F&openid.identity=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select&openid.assoc_handle=caflex&openid.mode=checkid_setup&openid.claimed_id=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0"
    },
    {
      "action": "waitForURL",
      "url": "/",
      "timeout": 120000
    }
  ],
  "getDocuments": [
    {
      "action": "navigate",
      "url": "https://www.{{config.domain}}/gp/css/order-history?timeFilter=year-{{currentDate.year}}&orderFilter=year-{{currentDate.year}}"
    },
    {
      "action": "extractAll",
      "script": "Array.from(document.querySelectorAll('#orderFilter>option[value*=year]'))\n  .map((e) => e.value.replace('year-', ''))\n  .filter((y) => Number(y) >= Number('{{startDate.year}}'))",
      "variable": "year",
      "forEach": [
        {
          "action": "navigate",
          "url": "https://www.{{config.domain}}/gp/css/order-history?timeFilter=year-{{year}}&orderFilter=year-{{year}}"
        },
        {
          "action": "extractAll",
          "selector": ".order-card,.order",
          "variable": "order",
          "fields": {
            "overviewUrl": {
              "selector": "a[href*='order-details']",
              "attribute": "href"
            },
            "id": {
              "selector": ".yohtmlc-order-id span:last-of-type"
            },
            "date": {
              "selector": ".a-col-left .a-column:nth-child(1) .a-size-base"
            },
            "price": {
              "selector": ".yohtmlc-order-total"
            }
          },
          "pagination": {
            "type": "next",
            "selector": ".a-pagination li:last-of-type:not(.a-disabled) a",
            "waitForSelector": ".order-card,.order"
          },
          "forEach": [
            {
              "action": "navigate",
              "url": "{{order.overviewUrl}}"
            },
            {
              "action": "extractAll",
              "selector": ".hide-if-js li:has(a[href$='invoice.pdf'])",
              "variable": "invoice",
              "fields": {
                "url": {
                  "selector": "a",
                  "attribute": "href"
                }
              },
              "forEach": [
                {
                  "action": "if",
                  "script": "document.querySelectorAll('.hide-if-js li:has(a[href$=\"invoice.pdf\"])').length >\n  1",
                  "then": [
                    {
                      "action": "downloadPdf",
                      "description": "Don't include the price when multiple invoices are present, since there is no reliable way to map them to the order.",
                      "url": "{{invoice.url}}",
                      "document": {
                        "id": "{{order.id}}-{{index}}",
                        "date": "{{order.date}}"
                      },
                      "metadata": {
                        "order": "{{order.id}}"
                      }
                    }
                  ],
                  "else": [
                    {
                      "action": "downloadPdf",
                      "description": "Use the price from the order when only one invoice is present.",
                      "url": "{{invoice.url}}",
                      "document": {
                        "id": "{{order.id}}",
                        "date": "{{order.date}}",
                        "total": "{{order.price}}"
                      },
                      "metadata": {
                        "order": "{{order.id}}"
                      }
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
